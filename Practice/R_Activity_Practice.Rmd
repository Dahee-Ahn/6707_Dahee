---
title: "R_Activity_Practice"
author: "Dahee Ahn"
date: "2024-09-06"
output: html_document
---
```{r}
rm(list= ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
```

```{r}
iris_df <- read_excel(path="C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week2/Iris_data_excel.xlsx", sheet="some_famous_data", range= "A1:E151")
```

```{r}
summary(iris_df)
```

```{r}
nrow(iris_df)
```

```{r}
str(iris_df)
```

```{r}
head(iris_df)
```

```{r}
tail(iris_df)
```

```{r}
View(iris_df)
```

```{r}
head(iris_df$Species)
```

```{r}
summary(iris_df$Species)
```

```{r}
is.character(iris_df$Species)
```

```{r}
iris_df$Species <- as.factor(iris_df$Species)
summary(iris_df$Species)
```

```{r}
sepal_greater5 <- iris_df$Sepal.Length > 5
table(sepal_greater5)
```

```{r}
sepal_equal5.1 <- iris_df$Sepal.Length == 5.1
table(sepal_equal5.1)
```

```{r}
x <- 5+5
x
```

```{r}
X <- 5+5; X
```

```{r}
y = 7+3; y
```

```{r}
y==x
```

```{r}
head(iris_df$Sepal.Length %in% c(5.1, 4.6, 6.0))
```

```{r}
head(which(iris_df$Sepal.Length %in% c(5.1, 4.6, 6.0)))
```

```{r}
iris_df[25, 2:3]
iris_df[c(26,31),]
iris_df[,]
iris_df[-5,1:2]
iris_df[which(iris_df$Sepal.Length>5),]
iris_df[which(iris_df$Sepal.Length==5.1),]
```

```{r}
tapply(iris_df$Sepal.Width, iris_df$Species, mean)
```

```{r}
install.packages("tidyverse")
library(tidyverse)
install.packages("conflicted")
library(conflicted)
```

```{r}
iris_df$Species <- as_factor(iris_df$Species)
```

```{r}
iris_df_subset_1 <- iris_df %>% dplyr::filter(Sepal.Length > 5)
summary(iris_df_subset_1)
```

```{r}
iris_df_subset_2 <- dplyr::filter(iris_df, Sepal.Length==5)
summary(iris_df_subset_2)
```

```{r}
species_counts <- table(iris_df_subset_1$Species)
print(species_counts)
```

```{r}
species_counts <- table(iris_df_subset_2$Species)
print(species_counts)
```

```{r}
iris_df %>% group_by(Species) %>% summarise(Means = mean(Sepal.Width), SD = sd(Sepal.Width), max_sep = max(Sepal.Width))
```

```{r}
iris_df %>% group_by(Species) %>% summarise(Means = mean(Sepal.Width), SD = sd(Sepal.Width), max_sep = max(Sepal.Width)) %>% arrange(Means)
```








```{r}
set.seed(123)
iris_df[sample(1:nrow(iris_df),10), "Sepal.Length"]
```

```{r}
tail(is.na(iris_df$Sepal.Length))
```
```{r}
mean(iris_df$"Sepal.Length")
```

```{r}
mean(na.omit(iris_df$"Sepal.Length"))
```

```{r}
mean(iris_df$"Sepal.Length", na.rm=T)
```

```{r}
try1 <- iris_df %>% dplyr::filter(Sepal.Length > mean(Sepal.Length, na.rm = TRUE))
summary(try1)
```

```{r}
set.seed(123)
sample(1:100,3)
```

## R_Activity_Practice_3

```{r}
library(datasets)
head(iris)
```

```{r}
plot(Sepal.Length~Petal.Width, data=iris)
```

```{r}
plot(Sepal.Length~Petal.Width, data=iris, pch=15, col="tomato4", xlab="Width of Petals", ylab="Length of Sepals")
```

```{r}
library("tidyverse")
library("ggplot2")
```

```{r}
ggplot(data=iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species)) + geom_point()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length)) + geom_point(shape=15, col="tomato4")
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species)) + geom_point()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()+theme(legend.position=c(0.2,0.8), legend.title=element_blank())
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()+xlab("Petal width (cm)")+ylab("Sepal length (cm)")+theme(legend.position="none")
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width))+geom_histogram(color="purple", fill="pink")+theme_classic()+theme(legend.position="none")
```

```{r}
ggplot(iris, mapping=aes(x=Species, y=Petal.Width, fill=Species))+geom_boxplot()+theme_classic()+scale_fill_manual(values=c("pink","purple","red"))+theme(legend.position="none")
```

```{r}
library(datasets)
library(tidyverse)
library(dplyr)
```

```{r}
iris_t <- iris %>% dplyr::filter(Species == c("versicolor", "virginica"))
boxplot(Sepal.Length~Species, data=iris_t)
```


```{r}
library(dplyr)
iris_t <- iris %>% dplyr::filter(Species == c("versicolor", "virginica")) %>% droplevels()
boxplot(Sepal.Length~Species, data = iris_t)
stripchart(Sepal.Length~Species, data = iris_t, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

```{r}
hist(iris$Sepal.Length)
```

```{r}
qqnorm(iris$Sepal.Length)
```

```{r}
var_check <- iris_t %>% group_by(Species) %>% summarise(Variance = var(Sepal.Length))
var_check$Variance[2]/var_check$Variance[1]
```

```{r}
group1 <- iris_t$Sepal.Length[iris_t$Species == "versicolor"]
group2 <- iris_t$Sepal.Length[iris_t$Species == "virginica"]
t.test(group1, group2, alternative = "two.sided", paired=F, var.equal=T)
```
```{r}
install.packages("plotrix")
library(plotrix)
iris_t %>% group_by(Species) %>% summarise(means = round(mean(Sepal.Length),2), SE = round(std.error(Sepal.Length),2))
```

```{r}
t.test(Sepal.Length~Species, data=iris_t, alternative = "two.sided", var.equal=T)
```

##R Activity 5
```{r}
ggplot(iris, mapping=aes(y=Sepal.Length, x=Species, fill=Species))+geom_boxplot()+theme_classic()+xlab("Species")+ylab("Sepal Length")
```

```{r}
fit_1 <- lm(Sepal.Length~Species, data=iris)
anova(fit_1)
```

```{r}
plot(fit_1, which=c(2))
```
##The errors
```{r}
plot(fit_1, which=c(1))
```

```{r}
fit_1_log <- lm(log(Sepal.Length)~Species, data=iris)
plot(fit_1_log, which=c(2))
```

```{r}
plot(fit_1_log, which=c(1))
```

```{r}
install.packages("emmeans")
library(emmeans)
emmeans(fit_1, pairwise~Species)
```
```{r}
install.packages("multcomp")
library(multcomp)
tukey_fit_1 <- glht(fit_1, linfct=mcp(Species="Tukey"))
summary(tukey_fit_1)
```

```{r}
library(plotrix) #for std.error function
```

```{r}
iris %>% group_by(Species) %>% summarise(means = mean(Sepal.Length), SE = std.error(Sepal.Length))
```

## Chi-squared analysis
```{r}
iris$size <- ifelse(iris$Sepal.Length < median(iris$Sepal.Length), "small", "big")
table(iris$Species, iris$size)
ggplot(iris)+aes(x=Species, fill=size)+geom_bar()+theme_bw()
chisq_test_1 <- chisq.test(table(iris$Species, iris$size))
chisq_test_1
install.packages("corrplot")
library(corrplot)
chisq_test_1
corrplot(chisq_test_1$residuals, is.cor = FALSE)
```
## Linear Models - refer to R_Activity_Assignment_4
```{r}
summary(pigs)
```

## Randomized complete block and latin square
```{r}
install.packages("car")
install.packages("lme4")
install.packages("lmerTest")
install.packages("agricolae")
library(car)
library(lme4)
library(lmerTest)
library(tidyverse)
library(agricolae)
library(emmeans)
```

## Randomized complete block
```{r}
trefoil <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/Trefoil.txt", header=T, sep="\t", colClasses = c("factor", "factor", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
head(trefoil)
summary(trefoil)
```
## wide vs. long format
```{r}
trefoil_long <- trefoil %>% pivot_longer(cols = starts_with("Pop"), names_to = "Population", values_to = "PlantWeight")
head(trefoil_long)
```
## aov()
```{r}
fit_aov_RCB <- aov(PlantWeight ~ Rep + Population, data=trefoil_long) # dependent variable ~ independent variable
summary(fit_aov_RCB)
```
## lm()
```{r}
fit_lm_RCB <- lm(PlantWeight ~ Rep + Population, data=trefoil_long)
Anova(fit_lm_RCB, type="III")
```

## Mixed-effects model
```{r}
fit_lmer_RCB <- lmer(PlantWeight ~ Population + (1|Rep), data=trefoil_long)
anova(fit_lmer_RCB, type=3)
```

## Pairwise comparisons
```{r}
emmeans(fit_lmer_RCB, pairwise~"Population")
```

## Latin squares
```{r}
sheep <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/sheep.csv", header=T, sep=",", colClasses = c("factor", "factor", "factor", "factor", "numeric"))
summary(sheep)
```
## aov() 분산 분석(ANOVA, Analysis of Variance)
```{r}
fit_aov_LS <- aov(digest ~ square + square/sheep + square/time + letter, data=sheep)
summary(fit_aov_LS)
```

# lm()
```{r}
fit_lm_LS <- lm(digest ~ square + square/sheep + square/time + letter, data=sheep)
anova(fit_lm_LS)
```

## Mixed-effects model
```{r}
fit_lmer_LS <- lmer(digest ~ letter + (1|square/sheep) + (1|square:time), data=sheep)
anova(fit_lmer_LS, type=3)
summary(fit_lmer_LS)
```

## Pairwise comparisons
```{r}
emmeans(fit_lmer_LS, pairwise~"letter")
```

############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
## R activity
```{r}
seed_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/EPP_seed.txt", header=T, sep="\t", colClasses=c("factor", "factor", "factor", NA))
summary(seed_df)
ggplot(seed_df, aes(x=tillage, y=yield, fill=herbicide)) + geom_boxplot() + theme_bw()
```

```{r}
lm_seed_1 <- lm(yield ~ rep + tillage + herbicide, data=seed_df)
Anova(lm_seed_1, type="III")
```

```{r}
emmeans(lm_seed_1, pairwise~tillage)
```

## Write 3-4 sentences summarizing your findings using “biologically meaningful” terms.

Answer: Yield of the perennial rye grass varied significantly between tillage treatments (F1,12 = 31.29, p < 0.0001) but herbicide had no effect (F1,12 = 0.37, p = 0.55), indicating that quackgrass is best managed by altering tillage. A pairwise comparison between tillage options indicated that tilling/seeding in spring sigificantly reduced yield by approx. 48g and 53g compared with tilling/seeding in fall (t12 = 6.55, p = 0.0001) and no tilling/fall seeding (t12 = 7.12, p < 0.0001). Treatments using fall seeding did not differ (t12 = −0.57, p = 0.84). Taken together, tillage and seeding should be completed in fall.

## Split plots
```{r}
oats_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/oats.txt", header=T, sep="\t", colClasses = c("factor", "factor", "factor", "factor", "numeric"))
summary(oats_df)
ggplot(oats_df, aes(x=Nitrogen, y=Yield, fill=Nitrogen)) + geom_boxplot() + theme_bw() + xlab("Year") + ylab("Yield") + facet_wrap(~Variety) + ggtitle("Split plot: Variety (whole plot)  \n and Nitrogen (subplot)")
```

## Agricolae package
```{r}
library(agricolae)
sp.plot(oats_df$Block, oats_df$Variety, oats_df$Nitrogen, oats_df$Yield)
```

## aov
```{r}
fit_aov_SP <- aov(Yield~Variety*Nitrogen + Error(Block/Variety), data=oats_df)
summary(fit_aov_SP)
```

## Mixed-effects model
```{r}
fit_lmer_SP <- lmer(Yield ~ Variety*Nitrogen + (1|Block) + (1|Block:Variety), data=oats_df)
anova(fit_lmer_SP, type=3)
emmeans(fit_lmer_SP, pairwise~"Nitrogen") # pairwise comparisons
```

## Split-split splot
```{r}
june_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/EPP_junegrass.txt", header=T, sep="\t", colClasses = c("factor", "factor", "factor", "factor", "numeric", "numeric", "numeric"))
summary(june_df)
library(ggplot2)
ggplot(june_df, aes(x=Variety, y=Plant_Height, fill=Growth_Regulator)) + geom_boxplot() + theme_bw() + xlab("Variety") + ylab("Plant Height (cm)") + facet_grid(Growth_Regulator~Fertility) + ggtitle("Split-split plot: Fertility (whole plot) \n Growth regulator (subplot) \n Variety (sub-subplot)") +  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
## Agricolae package
```{r}
ssp.plot(june_df$Rep, june_df$Fertility, june_df$Growth_Regulator, june_df$Variety, june_df$Plant_Height)
```

## aov()
```{r}
fit_aov_SSP <- aov(Plant_Height ~ Rep + Fertility*Growth_Regulator*Variety + Error(Rep/Fertility/Growth_Regulator), data=june_df)
summary(fit_aov_SSP)
```
## Mixed-effect model
```{r}
fit_lmer_SSP <- lmer(Plant_Height ~ Fertility*Growth_Regulator*Variety + (1|Rep) + (1:Rep:Fertility) + (1:Rep:Fertility:Growth_Regulator), data=june_df)
anova(fit_lmer_SSP, type=3)
```
## Pairwise comparisons
```{r}
emmeans(fit_lmer_SSP, pairwise~Variety)
```

## The effect of nitrogen fertilizer on yield (grams) from three varieties of wheat
```{r}
yield_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/EPP_yield.txt", header=T, sep="\t", colClasses= c("factor", "factor", NA, NA, NA))
summary(yield_df)
```

```{r}
yield_df_long <- yield_df %>% pivot_longer(cols = starts_with("Rep"), names_to = "Rep", values_to = "Yield")
summary(yield_df_long)
```

```{r}
ggplot(yield_df_long, aes(x=Variety, y=Yield, fill=Variety)) + geom_boxplot() + theme_bw() + xlab("Variety") + ylab("Yield (grams)") + facet_wrap(~Nitrogen, ncol=5)
```

```{r}
aov_yield_1 <- aov(Yield ~ Rep + Nitrogen + Variety + Error(Rep/Nitrogen), data=yield_df_long)
summary(aov_yield_1)
```

```{r}
lmer_yield_1 <- lmer(Yield ~ Nitrogen + Variety + (1|Rep) + (1|Rep:Nitrogen), data=yield_df_long)
anova(lmer_yield_1, type=3)
emmeans(lmer_yield_1, pairwise~Nitrogen)
emmeans(lmer_yield_1, pairwise~Variety)
```
## Write 4-5 sentences comparing the conclusions from the two approaches (i.e., using aov() vs. lmer()) including conclusions drawn from any pairwise comparisons you conducted. At least 1-2 of your sentences should include a conclusion written in “biologically meaningful” terms.

Answer: The analyses using aov() and lmer() were equivalent in terms of sums of squares and mean squares, but the F-values differed (FYI: it’s due to the differences in residual degrees of freedom). Yield varied across nitrogen levels (F4,38 = 17.19, p < 0.0001) and between varieties (F2,38 = 97.87, p < 0.0001).
Pairwise comparisons indicated that variety 3 produced a higher yield than variety 1 (Tukey's range test (TRT): t28 = 13.86, p < 0.0001) or variety 2 (TRT: t28 = 8.60, p < 0.0001). Even though nitrogen applications of 160 kg/ha were associated with the highest yield, yield at that rate did not differ from yield at applications 80 kg/ha (TRT: t8 = 1.03, p = 0.84); thus, to maximize yield, plant variety 3 should be planted and returns on yield from nitrogen applications beyond 80-100 kg/ha might be considered negligible.


## Transformations and Curvilinear Models (Week 8)
```{r}
fit_trees_1 <- lm(Volume~Girth, data=trees) 
summary(fit_trees_1)
```

```{r}
plot(fit_trees_1, which=c(1,2))
```

## A log or square-root transformation of the response variable can often help with correcting issues of normality and heteroscedasticity.
```{r}
fit_trees_log_1 <- lm(log(Volume)~Girth, data=trees)
summary(fit_trees_log_1)
plot(fit_trees_log_1, which=c(1,2))
```

## If we wanted to plot the line from our model with a log-transformation onto the graph, we would need to back-transform our predictions.
```{r}
new_data <- data.frame(Girth = seq(8, 21, 0.01))
new_data$Predicted_trees_lm <- predict(fit_trees_1, newdata=new_data)
new_data$Predicted_trees_lm_log <- exp(predict(fit_trees_log_1, newdata=new_data))
library(tidyverse)
ggplot(data=trees, mapping=aes(x=Girth, y=Volume))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=Girth, y=Predicted_trees_lm), linewidth=1)+geom_line(data=new_data, aes(x=Girth, y=Predicted_trees_lm_log), color="tomato1", linewidth=1)
```

## If on initial plotting or in the residual plots you notice some curvature, a curvilinear model might provide a better fit.
```{r}
fit_trees_poly <- lm(Volume~Girth + I(Girth^2), data=trees)
summary(fit_trees_poly)
plot(fit_trees_poly, which=c(1,2))
```

## Here is a plot comparing our three fits. When you transform either your response or predictor, the interpretation of the model changes, log=yellow, second order term = blue. 
```{r}
new_data <- data.frame(Girth=seq(8,21,0.01)
new_data$Pred_lm <- predict(fit_trees_1, newdata=new_data)
new_data$Pred_log <- exp(predict(fit_trees_log_1, newdata=new_data))
new_data$Pred_poly <- predict(fit_trees_poly, newdata=new_data)
ggplot(data=trees, mapping=aes(x=Girth, y=Volume))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=Girth, y=Pred_lm), linewidth=1.2)+geom_line(data=new_data, aes(x=Girth, y=Pred_log), color="yellow", linewidth=1.2)+geom_line(data=new_data, aes(x=Girth, y=Pred_poly), linetype="dashed", linewidth=1.2, color="blue")
```
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
## R Activity 6 Simple Linear Regression Practice / Fitting the model
```{r}
OT <- Orange[Orange$Tree == 1,]
ggplot(data=OT, mapping=aes (x=age, y=circumference))+geom_point()+theme_classic()+scale_y_continuous(limits = c(0,200), breaks=seq(0,200,by=50))+scale_x_continuous(limits=c(0,1600), breaks=seq(0,1500, by=300), expand=c(0,0))
```
## The circumference of our study tree increased with age such that a 1 unit increase in age was associated with ~0.08 unit increase in circumference.
```{r}
fit_oranges_1 <- lm(circumference~age, data=OT)
summary(fit_oranges_1)
```
## The bottom three lines of summary
## Residual standard error: 8.056 on 5 degrees of freedom = Residuals : Root 5(Df)/324.5(resudual sums of squares)
## Age t values = 12.973, 12.973^2 = F-value 168.29
```{r}
anova(fit_oranges_1)
```
## Checking assumptions
```{r}
plot(fit_oranges_1, which=c(1,2))
```

```{r}
fit_oranges_log_1 <- lm(log(circumference)~age, data=OT)
summary(fit_oranges_log_1)
plot(fit_oranges_log_1, which=c(1,2))
```

```{r}
qqnorm((residuals(fit_oranges_1)))
```

```{r}
plot(residuals(fit_oranges_1)~fitted.values(fit_oranges_1), xlab="Predicted values from fit_oranges_1", ylab="Residuals")
```

```{r}
plot(fit_oranges_1)
```
## Adding the fit line to a graph (Extrapolation)
```{r}
new_data <- data.frame(age=500)
predicted_val <- predict(fit_oranges_1, newdata=new_data);predicted_val
```

```{r}
new_data <- data.frame(age=seq(0,1600, 0.01))
new_data$predicted_values <- predict(fit_oranges_1, newdata=new_data)
head(new_data)
```

```{r}
ggplot(data=OT, mapping=aes(x=age, y=circumference))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=age, y=predicted_values))+scale_y_continuous(limits=c(0,200), breaks=seq(0,200,by=50))+scale_x_continuous(limits=c(0,1600), breaks=seq(0,1500,by=300), expand=c(0,0))
```

############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
## Week 9 Practice


Fitting a MLR (Multiple linear regression) model
```{r}
library(datasets)
fit_plants_1_nointeraction <- lm(uptake~conc+Type, data=CO2)
anova(fit_plants_1_nointeraction)
```

```{r}
summary(fit_plants_1_nointeraction)
```

```{r}
library(tidyverse)
library(sjPlot)
library(sjmisc)
plot_model(fit_plants_1_nointeraction, type="pred", terms= c("conc", "Type")) + theme_classic()
```

Interactions (=/ collinearity)
```{r}
fit_plants_1_interaction <- lm(uptake~conc*Type, data=CO2)
anova(fit_plants_1_interaction)
```

```{r}
summary(fit_plants_1_interaction)
```
```{r}
plot_model(fit_plants_1_interaction, type="pred", terms=c("conc", "Type"))+theme_classic()
```

##Multiple Anova (MANOVA)
```{r}
fit_manova <- lm(uptake~Treatment+Type+Treatment*Type, data=CO2)
anova(fit_manova)
```
Also note that instead of Treatment+Type+Treatment*Type, I could have written Treatment*Type and the same model would have been fit
```{r}
fit_mmanova <- lm(uptake~Treatment*Type, data=CO2)
anova(fit_mmanova)
```

```{r}
summary(fit_manova)
```
Estimating the means of our different treatment groups
```{r}
CO2 %>% group_by(Treatment, Type) %>% summarise(means = round(mean(uptake), 3)) %>% as.data.frame()
```

## Multiple comparisons in MLR

```{r}
library(emmeans)
```
5.1 No interaction, one categorical and one continuous predictor
```{r}
no_interaction_emm <- emmeans(fit_plants_1_nointeraction, ~Type)
pairs(no_interaction_emm)
```

5.2 Interaction between a categorical and a continuous predictor. Note that this is comparing the slopes of the uptake ~ conc relationship between the Quebec group and Mississippi group. So, the slope of uptake ~ conc is steeper by 0.0107 for the Quebec plants.
```{r}
fp_inter_emm <- emtrends(fit_plants_1_interaction, "Type", var= "conc")
pairs(fp_inter_emm)
```

5.3 No interaction, two categorical predictor
```{r}
fit_manova_no_interaction <- lm(uptake~Treatment+Type, data=CO2)
fit_manova_no_interaction_emm <- emmeans(fit_manova_no_interaction, ~Treatment)
pairs(fit_manova_no_interaction_emm)
```
5.4 Interaction between two categorical predictors
```{r}
manova_emm <- emmeans(fit_manova, ~Treatment*Type)
pairs(manova_emm)
```

## Sequential vs, marginal fitting


##Sequential fitting
```{r}
library(datasets)
data(grouseticks)
grouseticks$f_YEAR <- as.factor(grouseticks$YEAR)
fit_ex1 <- lm(TICKS ~ f_YEAR + HEIGHT, data=grouseticks)
anova(fit_ex1)
```
```{r}
fit_ex2 <- lm(TICKS ~ HEIGHT + f_YEAR, data=grouseticks)
anova(fit_ex2)
```

##Marginal fitting

```{r}
library(car)
```
When f_YEAR is listed first
```{r}
Anova(fit_ex1, type="III")
```

Wehn HEIGHT is listed first
```{r}
Anova(fit_ex2, type="III")
```

## Type 2 Sums of Squares
```{r}
fit_ex_SS <- lm(TICKS ~ f_YEAR + HEIGHT + f_YEAR*HEIGHT, data=grouseticks)
Anova(fit_ex_SS, type="II")
```

## Type 3 Sums of Squares
```{r}
Anova(fit_ex_SS, type="III")
```



############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
##Activity 8: Linear Mixed-Effects Models

# Fitting linear mixed-effects models
```{r}
library(lme4)
fit_example1 <- lmer(Response ~ Predictor + (1|Level3/Level2/Level1), data=made_up_data)
summary(fit_example1)
```

```{r}
fit_example2 <- lmer(Tree.height ~ DBH + (1|Region/Site/Plot), data=made_up_tree_data)
summary(fit_example_2)
```

```{r}
lmer_gaussian <- lmer(circumference~age + (1|Tree), data=Orange) #There is no p-value??
summary(lmer_gaussian)
```

# Adding an lmer() line to a graph
```{r}
new_data <- data.frame(age=seq(0, 1640, 0.01))
new_data$Predicted_lmer <- predict(lmer_gaussian, newdata=new_data, re.form=NA)
ggplot(data=Orange, mapping=aes(x=age, y=circumference, col=Tree))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=age, y=Predicted_lmer), color="dark blue", linewidth=1)
```

# Interpretation
As for the Estimates of the intercept and slope, you can interpret them equivalently to regression models that contain only fixed-effects.

# p-values and degrees of freedom
```{r}
library(lmerTest) #p-values are not provided out of the box in lme4, that is why we need ImerTest, which uses Satterthwaite's method
```

#ANOVA
```{r}
lmer_gaussian_fact <- lmer(circumference~factor(age)+ (1|Tree), data=Orange)
anova(lmer_gaussian_fact, type=3)
summary(lmer_gaussian_fact)
```

# Assumptions
```{r}
plot(lmer_gaussian) # You should assess the assumptions of normality and homoscedasticy. You can check the assumptions using very similar commands:
qqnorm(residuals(lmer_gaussian))
ranef_brood <- ranef(lmer_gaussian)$Tree # checking normality of tree random effect
qqnorm(ranef_brood$'(Intercept)')
hist(ranef_brood$`(Intercept)`)
```

# Random slope models
```{r}
lmer_gaussian_slope <- lmer(circumference~age + (age|Tree), data=Orange)
summary(lmer_gaussian_slope)
```

############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
############################################################################
## R Activity 9 Practice : Generalized Linear (Mixed-Effects) Models


# Logistic regression (Binary)
```{r}
library(lme4) 
data(grouseticks)
grouseticks$TICK_PRES <- ifelse(grouseticks$TICKS > 0, 1, 0)
```
```{r}
library(tidyverse)
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()
```

```{r}
fit_tick_logistic_1 <- glm(TICK_PRES~HEIGHT, data=grouseticks, family=binomial (link="logit"))
summary(fit_tick_logistic_1)
```
```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_logistic <- predict(fit_tick_logistic_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_logistic),linewidth=1)
```

## Interpretation
```{r}
install.packages("MASS")
library(MASS)
round(exp(cbind(coef(fit_tick_logistic_1), confint(fit_tick_logistic_1))), 3)
```

```{r}
dose.p(fit_tick_logistic_1, p = c(0.05, 0.5, 0.75))
```
 the elevation at which we would expect a 50% chance of finding a tick on a grouse was 497.75 ± 5.55 SE.


# Checking assumptions and other diagnostics
```{r}
library(dplyr)
library(ggplot2)
library(plotrix)
grouseticks_new <- grouseticks %>% mutate(new_bin = cut(HEIGHT, breaks=seq(400,540, 20)))
bins_for_plot <- grouseticks_new %>% group_by(new_bin)%>%
  summarise(means=mean(TICK_PRES), SDs=sd(TICK_PRES))
bins_for_plot$HEIGHT <- seq(410, 530, 20) # to ensure we can plot on same graph below
```

```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_logistic <- predict(fit_tick_logistic_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_point(data=bins_for_plot, aes(x=HEIGHT, y=means), col="tomato1", size=3) + geom_errorbar(data=bins_for_plot, mapping =aes(x=HEIGHT, y=means, ymin=means-SDs, ymax=means+SDs), linewidth=1, color="tomato1", width=.4) + geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_logistic), linewidth=1)
```


#Analysis of Deviance
```{r}
anova(fit_tick_logistic_1, test="Chisq")
```

```{r}
intercept_only <- glm(TICK_PRES~1, data=grouseticks, family=binomial(link="logit"))
anova(intercept_only, fit_tick_logistic_1, test="Chisq")
```

# ROCs(Receiver operating characteristic curve = rock plot) and AUC (Area unver the curve)
Making a ROC plot
```{r}
library(pROC)
predicted <- predict(fit_tick_logistic_1, type="response")
roccurve <- roc(grouseticks$TICK_PRES ~ predicted)
ggroc(roccurve)+theme_classic()+geom_segment(aes(x=1, xend=0, y=0, yend=1), color="grey", linetype="dashed")
```

auc(roccurve)

############################################################################
#Poisson Regression (Count)

```{r}
fit_tick_poisson_1 <- glm(TICKS~HEIGHT, data=grouseticks, family=poisson(link="log"))
summary(fit_tick_poisson_1)
```

```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_poisson <- predict(fit_tick_poisson_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICKS))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_poisson), linewidth=1)
```

# Interpretation
the expected number of ticks changes by a multiplicative factor of 0.98 (= exp(−0.0230647)), or a 2.3% decrease (= (1−0.977)×100), with an increase in 1 unit of elevation.

# Checking assumptions and other diagnostics
```{r}
anova(fit_tick_poisson_1, test="Chisq")
```
#Overdispersion
```{r}
install.packages("AER")
library(AER)
deviance(fit_tick_poisson_1)/fit_tick_poisson_1$df.residual
```
```{r}
dispersiontest(fit_tick_poisson_1)
```

```{r}
library(MASS)
fit_tick_negbin_1 <- glm.nb(TICKS~HEIGHT, data=grouseticks)
summary(fit_tick_negbin_1)
```

# Zero-inflated Poisson
```{r}
install.packages("pscl")
library(pscl)
ZI_pois <- zeroinfl(TICKS~HEIGHT, data=grouseticks, dist="poisson")
summary(ZI_pois)
```
```{r}
AIC(fit_tick_poisson_1, ZI_pois)
```

# Zero-inflated Negative Binomial
```{r}
ZI_negbin <- zeroinfl(TICKS~HEIGHT, data=grouseticks, dist="negbin")
summary(ZI_negbin)
```
###########################################################################
# Fitting an offset variable
```{r}
beetles <- read.csv("C:/Users/chemk/Desktop/Classes/ENT6707_DataAnalysis/week11/examples/completely_fabricated_data/beetles.csv")
summary(beetles)
```

```{r}
set.seed(123)
beetles$woodlot_size <- runif(nrow(beetles), 1,2)
summary(beetles)
```

```{r}
fit_beetles_a <- glm(ELB/woodlot_size~temperature, data=beetles, family=poisson(link=log))
summary(fit_beetles_a)
```
#Use an offset vaiable, ensuring our response variable remains as an integer.
```{r}
fit3b <- glm(ELB~temperature + offset(woodlot_size),data=beetles,family=poisson(link=log))
summary(fit3b)
```

```{r}
fit3c <- glm(ELB~temperature + woodlot_size, data=beetles, family=poisson(link=log))
summary(fit3c)
```

#####################################################################################
#Generalized linear mixed-effects models
```{r}
grouseticks$TICK_PRES <- ifelse(grouseticks$TICKS > 0, 1, 0)
library(lme4)
glmer_binomial <- glmer(TICK_PRES ~ cHEIGHT + (1|BROOD), data=grouseticks, family=binomial(link="logit"))
summary(glmer_binomial)
```

#Plotting mixed effects logistic regression
```{r}
new_data_me <- data.frame(cHEIGHT=seq(-60, 71, 0.001))
new_data_me$Predicted_TICKS_logistic <- predict(glmer_binomial, newdata=new_data_me, type="response", re.form=NA)
ggplot(data=grouseticks, mapping=aes(x=cHEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_line(data=new_data_me, aes(x=cHEIGHT, y=Predicted_TICKS_logistic), linewidth=1)
```

# Poisson response variables
```{r}
glmer_poisson <- glmer(TICKS~cHEIGHT + (1|BROOD), data=grouseticks, family=poisson(link="log"))
summary(glmer_poisson)
```
# Plotting mixed effects Poisson regression
```{r}
new_data_pois_me <- data.frame(cHEIGHT = seq(-60, 71, 0.001))
new_data_pois_me$Predicted_TICKS_poisson <- predict(glmer_poisson, newdata=new_data_pois_me, type="response", re.form=NA)
ggplot(data=grouseticks, mapping=aes(x=cHEIGHT, y=TICKS))+geom_point()+theme_classic()+geom_line(data=new_data_pois_me, aes(x=cHEIGHT, y=Predicted_TICKS_poisson), linewidth=1)
```

