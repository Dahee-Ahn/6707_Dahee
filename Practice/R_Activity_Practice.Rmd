---
title: "R_Activity_Practice"
author: "Dahee Ahn"
date: "2024-09-06"
output: html_document
---
```{r}
rm(list= ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
```

```{r}
iris_df <- read_excel(path="C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week2/Iris_data_excel.xlsx", sheet="some_famous_data", range= "A1:E151")
```

```{r}
summary(iris_df)
```

```{r}
nrow(iris_df)
```

```{r}
str(iris_df)
```

```{r}
head(iris_df)
```

```{r}
tail(iris_df)
```

```{r}
View(iris_df)
```

```{r}
head(iris_df$Species)
```

```{r}
summary(iris_df$Species)
```

```{r}
is.character(iris_df$Species)
```

```{r}
iris_df$Species <- as.factor(iris_df$Species)
summary(iris_df$Species)
```

```{r}
sepal_greater5 <- iris_df$Sepal.Length > 5
table(sepal_greater5)
```

```{r}
sepal_equal5.1 <- iris_df$Sepal.Length == 5.1
table(sepal_equal5.1)
```

```{r}
x <- 5+5
x
```

```{r}
X <- 5+5; X
```

```{r}
y = 7+3; y
```

```{r}
y==x
```

```{r}
head(iris_df$Sepal.Length %in% c(5.1, 4.6, 6.0))
```

```{r}
head(which(iris_df$Sepal.Length %in% c(5.1, 4.6, 6.0)))
```

```{r}
iris_df[25, 2:3]
iris_df[c(26,31),]
iris_df[,]
iris_df[-5,1:2]
iris_df[which(iris_df$Sepal.Length>5),]
iris_df[which(iris_df$Sepal.Length==5.1),]
```

```{r}
tapply(iris_df$Sepal.Width, iris_df$Species, mean)
```

```{r}
install.packages("tidyverse")
library(tidyverse)
install.packages("conflicted")
library(conflicted)
```

```{r}
iris_df$Species <- as_factor(iris_df$Species)
```

```{r}
iris_df_subset_1 <- iris_df %>% dplyr::filter(Sepal.Length > 5)
summary(iris_df_subset_1)
```

```{r}
iris_df_subset_2 <- dplyr::filter(iris_df, Sepal.Length==5)
summary(iris_df_subset_2)
```

```{r}
species_counts <- table(iris_df_subset_1$Species)
print(species_counts)
```

```{r}
species_counts <- table(iris_df_subset_2$Species)
print(species_counts)
```

```{r}
iris_df %>% group_by(Species) %>% summarise(Means = mean(Sepal.Width), SD = sd(Sepal.Width), max_sep = max(Sepal.Width))
```

```{r}
iris_df %>% group_by(Species) %>% summarise(Means = mean(Sepal.Width), SD = sd(Sepal.Width), max_sep = max(Sepal.Width)) %>% arrange(Means)
```








```{r}
set.seed(123)
iris_df[sample(1:nrow(iris_df),10), "Sepal.Length"]
```

```{r}
tail(is.na(iris_df$Sepal.Length))
```
```{r}
mean(iris_df$"Sepal.Length")
```

```{r}
mean(na.omit(iris_df$"Sepal.Length"))
```

```{r}
mean(iris_df$"Sepal.Length", na.rm=T)
```

```{r}
try1 <- iris_df %>% dplyr::filter(Sepal.Length > mean(Sepal.Length, na.rm = TRUE))
summary(try1)
```

```{r}
set.seed(123)
sample(1:100,3)
```

## R_Activity_Practice_3

```{r}
library(datasets)
head(iris)
```

```{r}
plot(Sepal.Length~Petal.Width, data=iris)
```

```{r}
plot(Sepal.Length~Petal.Width, data=iris, pch=15, col="tomato4", xlab="Width of Petals", ylab="Length of Sepals")
```

```{r}
library("tidyverse")
library("ggplot2")
```

```{r}
ggplot(data=iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species)) + geom_point()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length)) + geom_point(shape=15, col="tomato4")
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species)) + geom_point()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()+theme(legend.position=c(0.2,0.8), legend.title=element_blank())
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width, y=Sepal.Length, col=Species, shape=Species))+geom_point()+theme_classic()+xlab("Petal width (cm)")+ylab("Sepal length (cm)")+theme(legend.position="none")
```

```{r}
ggplot(iris, mapping=aes(x=Petal.Width))+geom_histogram(color="purple", fill="pink")+theme_classic()+theme(legend.position="none")
```

```{r}
ggplot(iris, mapping=aes(x=Species, y=Petal.Width, fill=Species))+geom_boxplot()+theme_classic()+scale_fill_manual(values=c("pink","purple","red"))+theme(legend.position="none")
```

```{r}
library(datasets)
library(tidyverse)
library(dplyr)
```

```{r}
iris_t <- iris %>% dplyr::filter(Species == c("versicolor", "virginica"))
boxplot(Sepal.Length~Species, data=iris_t)
```


```{r}
library(dplyr)
iris_t <- iris %>% dplyr::filter(Species == c("versicolor", "virginica")) %>% droplevels()
boxplot(Sepal.Length~Species, data = iris_t)
stripchart(Sepal.Length~Species, data = iris_t, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

```{r}
hist(iris$Sepal.Length)
```

```{r}
qqnorm(iris$Sepal.Length)
```

```{r}
var_check <- iris_t %>% group_by(Species) %>% summarise(Variance = var(Sepal.Length))
var_check$Variance[2]/var_check$Variance[1]
```

```{r}
group1 <- iris_t$Sepal.Length[iris_t$Species == "versicolor"]
group2 <- iris_t$Sepal.Length[iris_t$Species == "virginica"]
t.test(group1, group2, alternative = "two.sided", paired=F, var.equal=T)
```
```{r}
install.packages("plotrix")
library(plotrix)
iris_t %>% group_by(Species) %>% summarise(means = round(mean(Sepal.Length),2), SE = round(std.error(Sepal.Length),2))
```

```{r}
t.test(Sepal.Length~Species, data=iris_t, alternative = "two.sided", var.equal=T)
```

##R Activity 5
```{r}
ggplot(iris, mapping=aes(y=Sepal.Length, x=Species, fill=Species))+geom_boxplot()+theme_classic()+xlab("Species")+ylab("Sepal Length")
```

```{r}
fit_1 <- lm(Sepal.Length~Species, data=iris)
anova(fit_1)
```

```{r}
plot(fit_1, which=c(2))
```
##The errors
```{r}
plot(fit_1, which=c(1))
```

```{r}
fit_1_log <- lm(log(Sepal.Length)~Species, data=iris)
plot(fit_1_log, which=c(2))
```

```{r}
plot(fit_1_log, which=c(1))
```

```{r}
install.packages("emmeans")
library(emmeans)
emmeans(fit_1, pairwise~Species)
```
```{r}
install.packages("multcomp")
library(multcomp)
tukey_fit_1 <- glht(fit_1, linfct=mcp(Species="Tukey"))
summary(tukey_fit_1)
```

```{r}
library(plotrix) #for std.error function
```

```{r}
iris %>% group_by(Species) %>% summarise(means = mean(Sepal.Length), SE = std.error(Sepal.Length))
```

## Chi-squared analysis
```{r}
iris$size <- ifelse(iris$Sepal.Length < median(iris$Sepal.Length), "small", "big")
table(iris$Species, iris$size)
ggplot(iris)+aes(x=Species, fill=size)+geom_bar()+theme_bw()
chisq_test_1 <- chisq.test(table(iris$Species, iris$size))
chisq_test_1
install.packages("corrplot")
library(corrplot)
chisq_test_1
corrplot(chisq_test_1$residuals, is.cor = FALSE)
```
## Linear Models - refer to R_Activity_Assignment_4
```{r}
summary(pigs)
```

## Randomized complete block and latin square
```{r}
install.packages("car")
install.packages("lme4")
install.packages("lmerTest")
install.packages("agricolae")
library(car)
library(lme4)
library(lmerTest)
library(tidyverse)
library(agricolae)
library(emmeans)
```

## Randomized complete block
```{r}
trefoil <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/Trefoil.txt", header=T, sep="\t", colClasses = c("factor", "factor", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
head(trefoil)
summary(trefoil)
```
## wide vs. long format
```{r}
trefoil_long <- trefoil %>% pivot_longer(cols = starts_with("Pop"), names_to = "Population", values_to = "PlantWeight")
head(trefoil_long)
```
## aov()
```{r}
fit_aov_RCB <- aov(PlantWeight ~ Rep + Population, data=trefoil_long) # dependent variable ~ independent variable
summary(fit_aov_RCB)
```
## lm()
```{r}
fit_lm_RCB <- lm(PlantWeight ~ Rep + Population, data=trefoil_long)
Anova(fit_lm_RCB, type="III")
```

## Mixed-effects model
```{r}
fit_lmer_RCB <- lmer(PlantWeight ~ Population + (1|Rep), data=trefoil_long)
anova(fit_lmer_RCB, type=3)
```

## Pairwise comparisons
```{r}
emmeans(fit_lmer_RCB, pairwise~"Population")
```

## Latin squares
```{r}
sheep <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/sheep.csv", header=T, sep=",", colClasses = c("factor", "factor", "factor", "factor", "numeric"))
summary(sheep)
```
## aov() 분산 분석(ANOVA, Analysis of Variance)
```{r}
fit_aov_LS <- aov(digest ~ square + square/sheep + square/time + letter, data=sheep)
summary(fit_aov_LS)
```

# lm()
```{r}
fit_lm_LS <- lm(digest ~ square + square/sheep + square/time + letter, data=sheep)
anova(fit_lm_LS)
```

## Mixed-effects model
```{r}
fit_lmer_LS <- lmer(digest ~ letter + (1|square/sheep) + (1|square:time), data=sheep)
anova(fit_lmer_LS, type=3)
summary(fit_lmer_LS)
```

## Pairwise comparisons
```{r}
emmeans(fit_lmer_LS, pairwise~"letter")
```

_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

## R activity 5
```{r}
seed_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_RCB/EPP_seed.txt", header=T, sep="\t", colClasses=c("factor", "factor", "factor", NA))
summary(seed_df)
ggplot(seed_df, aes(x=tillage, y=yield, fill=herbicide)) + geom_boxplot() + theme_bw()
```

```{r}
lm_seed_1 <- lm(yield ~ rep + tillage + herbicide, data=seed_df)
Anova(lm_seed_1, type="III")
```

```{r}
emmeans(lm_seed_1, pairwise~tillage)
```

## Write 3-4 sentences summarizing your findings using “biologically meaningful” terms.

Answer: Yield of the perennial rye grass varied significantly between tillage treatments (F1,12 = 31.29, p < 0.0001) but herbicide had no effect (F1,12 = 0.37, p = 0.55), indicating that quackgrass is best managed by altering tillage. A pairwise comparison between tillage options indicated that tilling/seeding in spring sigificantly reduced yield by approx. 48g and 53g compared with tilling/seeding in fall (t12 = 6.55, p = 0.0001) and no tilling/fall seeding (t12 = 7.12, p < 0.0001). Treatments using fall seeding did not differ (t12 = −0.57, p = 0.84). Taken together, tillage and seeding should be completed in fall.

## Split plots
```{r}
oats_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/oats.txt", header=T, sep="\t", colClasses = c("factor", "factor", "factor", "factor", "numeric"))
summary(oats_df)
ggplot(oats_df, aes(x=Nitrogen, y=Yield, fill=Nitrogen)) + geom_boxplot() + theme_bw() + xlab("Year") + ylab("Yield") + facet_wrap(~Variety) + ggtitle("Split plot: Variety (whole plot)  \n and Nitrogen (subplot)")
```

## Agricolae package
```{r}
library(agricolae)
sp.plot(oats_df$Block, oats_df$Variety, oats_df$Nitrogen, oats_df$Yield)
```

## aov
```{r}
fit_aov_SP <- aov(Yield~Variety*Nitrogen + Error(Block/Variety), data=oats_df)
summary(fit_aov_SP)
```

## Mixed-effects model
```{r}
fit_lmer_SP <- lmer(Yield ~ Variety*Nitrogen + (1|Block) + (1|Block:Variety), data=oats_df)
anova(fit_lmer_SP, type=3)
emmeans(fit_lmer_SP, pairwise~"Nitrogen") # pairwise comparisons
```

## Split-split splot
```{r}
june_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/EPP_junegrass.txt", header=T, sep="\t", colClasses = c("factor", "factor", "factor", "factor", "numeric", "numeric", "numeric"))
summary(june_df)
library(ggplot2)
ggplot(june_df, aes(x=Variety, y=Plant_Height, fill=Growth_Regulator)) + geom_boxplot() + theme_bw() + xlab("Variety") + ylab("Plant Height (cm)") + facet_grid(Growth_Regulator~Fertility) + ggtitle("Split-split plot: Fertility (whole plot) \n Growth regulator (subplot) \n Variety (sub-subplot)") +  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
## Agricolae package
```{r}
ssp.plot(june_df$Rep, june_df$Fertility, june_df$Growth_Regulator, june_df$Variety, june_df$Plant_Height)
```

## aov()
```{r}
fit_aov_SSP <- aov(Plant_Height ~ Rep + Fertility*Growth_Regulator*Variety + Error(Rep/Fertility/Growth_Regulator), data=june_df)
summary(fit_aov_SSP)
```
## Mixed-effect model
```{r}
fit_lmer_SSP <- lmer(Plant_Height ~ Fertility*Growth_Regulator*Variety + (1|Rep) + (1:Rep:Fertility) + (1:Rep:Fertility:Growth_Regulator), data=june_df)
anova(fit_lmer_SSP, type=3)
```
## Pairwise comparisons
```{r}
emmeans(fit_lmer_SSP, pairwise~Variety)
```

## The effect of nitrogen fertilizer on yield (grams) from three varieties of wheat
```{r}
yield_df <- read.table("C:/Users/chemk/OneDrive/Desktop/Classes/ENT6707_DataAnalysis/week7/Supplemental_SplitPlot/EPP_yield.txt", header=T, sep="\t", colClasses= c("factor", "factor", NA, NA, NA))
summary(yield_df)
```

```{r}
yield_df_long <- yield_df %>% pivot_longer(cols = starts_with("Rep"), names_to = "Rep", values_to = "Yield")
summary(yield_df_long)
```

```{r}
ggplot(yield_df_long, aes(x=Variety, y=Yield, fill=Variety)) + geom_boxplot() + theme_bw() + xlab("Variety") + ylab("Yield (grams)") + facet_wrap(~Nitrogen, ncol=5)
```

```{r}
aov_yield_1 <- aov(Yield ~ Rep + Nitrogen + Variety + Error(Rep/Nitrogen), data=yield_df_long)
summary(aov_yield_1)
```

```{r}
lmer_yield_1 <- lmer(Yield ~ Nitrogen + Variety + (1|Rep) + (1|Rep:Nitrogen), data=yield_df_long)
anova(lmer_yield_1, type=3)
emmeans(lmer_yield_1, pairwise~Nitrogen)
emmeans(lmer_yield_1, pairwise~Variety)
```
## Write 4-5 sentences comparing the conclusions from the two approaches (i.e., using aov() vs. lmer()) including conclusions drawn from any pairwise comparisons you conducted. At least 1-2 of your sentences should include a conclusion written in “biologically meaningful” terms.

Answer: The analyses using aov() and lmer() were equivalent in terms of sums of squares and mean squares, but the F-values differed (FYI: it’s due to the differences in residual degrees of freedom). Yield varied across nitrogen levels (F4,38 = 17.19, p < 0.0001) and between varieties (F2,38 = 97.87, p < 0.0001).
Pairwise comparisons indicated that variety 3 produced a higher yield than variety 1 (Tukey's range test (TRT): t28 = 13.86, p < 0.0001) or variety 2 (TRT: t28 = 8.60, p < 0.0001). Even though nitrogen applications of 160 kg/ha were associated with the highest yield, yield at that rate did not differ from yield at applications 80 kg/ha (TRT: t8 = 1.03, p = 0.84); thus, to maximize yield, plant variety 3 should be planted and returns on yield from nitrogen applications beyond 80-100 kg/ha might be considered negligible.


## Transformations and Curvilinear Models (Week 8)
```{r}
fit_trees_1 <- lm(Volume~Girth, data=trees) 
summary(fit_trees_1)
```

```{r}
plot(fit_trees_1, which=c(1,2))
```

## A log or square-root transformation of the response variable can often help with correcting issues of normality and heteroscedasticity.
```{r}
fit_trees_log_1 <- lm(log(Volume)~Girth, data=trees)
summary(fit_trees_log_1)
plot(fit_trees_log_1, which=c(1,2))
```

## If we wanted to plot the line from our model with a log-transformation onto the graph, we would need to back-transform our predictions.
```{r}
new_data <- data.frame(Girth = seq(8, 21, 0.01))
new_data$Predicted_trees_lm <- predict(fit_trees_1, newdata=new_data)
new_data$Predicted_trees_lm_log <- exp(predict(fit_trees_log_1, newdata=new_data))
library(tidyverse)
ggplot(data=trees, mapping=aes(x=Girth, y=Volume))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=Girth, y=Predicted_trees_lm), linewidth=1)+geom_line(data=new_data, aes(x=Girth, y=Predicted_trees_lm_log), color="tomato1", linewidth=1)
```

## If on initial plotting or in the residual plots you notice some curvature, a curvilinear model might provide a better fit.
```{r}
fit_trees_poly <- lm(Volume~Girth + I(Girth^2), data=trees)
summary(fit_trees_poly)
plot(fit_trees_poly, which=c(1,2))
```

## Here is a plot comparing our three fits. When you transform either your response or predictor, the interpretation of the model changes, log=yellow, second order term = blue. 
```{r}
new_data <- data.frame(Girth=seq(8,21,0.01)
new_data$Pred_lm <- predict(fit_trees_1, newdata=new_data)
new_data$Pred_log <- exp(predict(fit_trees_log_1, newdata=new_data))
new_data$Pred_poly <- predict(fit_trees_poly, newdata=new_data)
ggplot(data=trees, mapping=aes(x=Girth, y=Volume))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=Girth, y=Pred_lm), linewidth=1.2)+geom_line(data=new_data, aes(x=Girth, y=Pred_log), color="yellow", linewidth=1.2)+geom_line(data=new_data, aes(x=Girth, y=Pred_poly), linetype="dashed", linewidth=1.2, color="blue")
```
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

## R Activity 6: Simple Linear Regression Practice / Fitting the model
```{r}
OT <- Orange[Orange$Tree == 1,]
ggplot(data=OT, mapping=aes (x=age, y=circumference))+geom_point()+theme_classic()+scale_y_continuous(limits = c(0,200), breaks=seq(0,200,by=50))+scale_x_continuous(limits=c(0,1600), breaks=seq(0,1500, by=300), expand=c(0,0))
```
## The circumference of our study tree increased with age such that a 1 unit increase in age was associated with ~0.08 unit increase in circumference.
```{r}
fit_oranges_1 <- lm(circumference~age, data=OT)
summary(fit_oranges_1)
```
## The bottom three lines of summary
## Residual standard error: 8.056 on 5 degrees of freedom = Residuals : Root 5(Df)/324.5(resudual sums of squares)
## Age t values = 12.973, 12.973^2 = F-value 168.29
```{r}
anova(fit_oranges_1)
```
## Checking assumptions
```{r}
plot(fit_oranges_1, which=c(1,2))
```

```{r}
fit_oranges_log_1 <- lm(log(circumference)~age, data=OT)
summary(fit_oranges_log_1)
plot(fit_oranges_log_1, which=c(1,2))
```

```{r}
qqnorm((residuals(fit_oranges_1)))
```

```{r}
plot(residuals(fit_oranges_1)~fitted.values(fit_oranges_1), xlab="Predicted values from fit_oranges_1", ylab="Residuals")
```

```{r}
plot(fit_oranges_1)
```
## Adding the fit line to a graph (Extrapolation)
```{r}
new_data <- data.frame(age=500)
predicted_val <- predict(fit_oranges_1, newdata=new_data);predicted_val
```

```{r}
new_data <- data.frame(age=seq(0,1600, 0.01))
new_data$predicted_values <- predict(fit_oranges_1, newdata=new_data)
head(new_data)
```

```{r}
ggplot(data=OT, mapping=aes(x=age, y=circumference))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=age, y=predicted_values))+scale_y_continuous(limits=c(0,200), breaks=seq(0,200,by=50))+scale_x_continuous(limits=c(0,1600), breaks=seq(0,1500,by=300), expand=c(0,0))
```

_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

# R activity 7 Practice


Fitting a MLR (Multiple linear regression) model
```{r}
library(datasets)
fit_plants_1_nointeraction <- lm(uptake~conc+Type, data=CO2)
anova(fit_plants_1_nointeraction)
```

```{r}
summary(fit_plants_1_nointeraction)
```

```{r}
library(tidyverse)
library(sjPlot)
library(sjmisc)
plot_model(fit_plants_1_nointeraction, type="pred", terms= c("conc", "Type")) + theme_classic()
```

Interactions (=/ collinearity)
```{r}
fit_plants_1_interaction <- lm(uptake~conc*Type, data=CO2)
anova(fit_plants_1_interaction)
```

```{r}
summary(fit_plants_1_interaction)
```
```{r}
plot_model(fit_plants_1_interaction, type="pred", terms=c("conc", "Type"))+theme_classic()
```

##Multiple Anova (MANOVA)
```{r}
fit_manova <- lm(uptake~Treatment+Type+Treatment*Type, data=CO2)
anova(fit_manova)
```
Also note that instead of Treatment+Type+Treatment*Type, I could have written Treatment*Type and the same model would have been fit
```{r}
fit_mmanova <- lm(uptake~Treatment*Type, data=CO2)
anova(fit_mmanova)
```

```{r}
summary(fit_manova)
```
Estimating the means of our different treatment groups
```{r}
CO2 %>% group_by(Treatment, Type) %>% summarise(means = round(mean(uptake), 3)) %>% as.data.frame()
```

## Multiple comparisons in MLR

```{r}
library(emmeans)
```
5.1 No interaction, one categorical and one continuous predictor
```{r}
no_interaction_emm <- emmeans(fit_plants_1_nointeraction, ~Type)
pairs(no_interaction_emm)
```

5.2 Interaction between a categorical and a continuous predictor. Note that this is comparing the slopes of the uptake ~ conc relationship between the Quebec group and Mississippi group. So, the slope of uptake ~ conc is steeper by 0.0107 for the Quebec plants.
```{r}
fp_inter_emm <- emtrends(fit_plants_1_interaction, "Type", var= "conc")
pairs(fp_inter_emm)
```

5.3 No interaction, two categorical predictor
```{r}
fit_manova_no_interaction <- lm(uptake~Treatment+Type, data=CO2)
fit_manova_no_interaction_emm <- emmeans(fit_manova_no_interaction, ~Treatment)
pairs(fit_manova_no_interaction_emm)
```
5.4 Interaction between two categorical predictors
```{r}
manova_emm <- emmeans(fit_manova, ~Treatment*Type)
pairs(manova_emm)
```

## Sequential vs, marginal fitting


##Sequential fitting
```{r}
library(datasets)
data(grouseticks)
grouseticks$f_YEAR <- as.factor(grouseticks$YEAR)
fit_ex1 <- lm(TICKS ~ f_YEAR + HEIGHT, data=grouseticks)
anova(fit_ex1)
```
```{r}
fit_ex2 <- lm(TICKS ~ HEIGHT + f_YEAR, data=grouseticks)
anova(fit_ex2)
```

##Marginal fitting

```{r}
library(car)
```
When f_YEAR is listed first
```{r}
Anova(fit_ex1, type="III")
```

Wehn HEIGHT is listed first
```{r}
Anova(fit_ex2, type="III")
```

## Type 2 Sums of Squares
```{r}
fit_ex_SS <- lm(TICKS ~ f_YEAR + HEIGHT + f_YEAR*HEIGHT, data=grouseticks)
Anova(fit_ex_SS, type="II")
```

## Type 3 Sums of Squares
```{r}
Anova(fit_ex_SS, type="III")
```



_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

# Activity 8: Linear Mixed-Effects Models

# Fitting linear mixed-effects models
```{r}
library(lme4)
fit_example1 <- lmer(Response ~ Predictor + (1|Level3/Level2/Level1), data=made_up_data)
summary(fit_example1)
```

```{r}
fit_example2 <- lmer(Tree.height ~ DBH + (1|Region/Site/Plot), data=made_up_tree_data)
summary(fit_example_2)
```

```{r}
lmer_gaussian <- lmer(circumference~age + (1|Tree), data=Orange) #There is no p-value??
summary(lmer_gaussian)
```

# Adding an lmer() line to a graph
```{r}
new_data <- data.frame(age=seq(0, 1640, 0.01))
new_data$Predicted_lmer <- predict(lmer_gaussian, newdata=new_data, re.form=NA)
ggplot(data=Orange, mapping=aes(x=age, y=circumference, col=Tree))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=age, y=Predicted_lmer), color="dark blue", linewidth=1)
```

# Interpretation
As for the Estimates of the intercept and slope, you can interpret them equivalently to regression models that contain only fixed-effects.

# p-values and degrees of freedom
```{r}
library(lmerTest) #p-values are not provided out of the box in lme4, that is why we need ImerTest, which uses Satterthwaite's method
```

#ANOVA
```{r}
lmer_gaussian_fact <- lmer(circumference~factor(age)+ (1|Tree), data=Orange)
anova(lmer_gaussian_fact, type=3)
summary(lmer_gaussian_fact)
```

# Assumptions
```{r}
plot(lmer_gaussian) # You should assess the assumptions of normality and homoscedasticy. You can check the assumptions using very similar commands:
qqnorm(residuals(lmer_gaussian))
ranef_brood <- ranef(lmer_gaussian)$Tree # checking normality of tree random effect
qqnorm(ranef_brood$'(Intercept)')
hist(ranef_brood$`(Intercept)`)
```

# Random slope models
```{r}
lmer_gaussian_slope <- lmer(circumference~age + (age|Tree), data=Orange)
summary(lmer_gaussian_slope)
```

_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

## R Activity 9 Practice : Generalized Linear (Mixed-Effects) Models


# Logistic regression (Binary)
```{r}
library(lme4) 
data(grouseticks)
grouseticks$TICK_PRES <- ifelse(grouseticks$TICKS > 0, 1, 0)
```
```{r}
library(tidyverse)
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()
```

```{r}
fit_tick_logistic_1 <- glm(TICK_PRES~HEIGHT, data=grouseticks, family=binomial (link="logit"))
summary(fit_tick_logistic_1)
```
```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_logistic <- predict(fit_tick_logistic_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_logistic),linewidth=1)
```

## Interpretation
```{r}
install.packages("MASS")
library(MASS)
round(exp(cbind(coef(fit_tick_logistic_1), confint(fit_tick_logistic_1))), 3)
```

```{r}
dose.p(fit_tick_logistic_1, p = c(0.05, 0.5, 0.75))
```
 the elevation at which we would expect a 50% chance of finding a tick on a grouse was 497.75 ± 5.55 SE.


# Checking assumptions and other diagnostics
```{r}
library(dplyr)
library(ggplot2)
library(plotrix)
grouseticks_new <- grouseticks %>% mutate(new_bin = cut(HEIGHT, breaks=seq(400,540, 20)))
bins_for_plot <- grouseticks_new %>% group_by(new_bin)%>%
  summarise(means=mean(TICK_PRES), SDs=sd(TICK_PRES))
bins_for_plot$HEIGHT <- seq(410, 530, 20) # to ensure we can plot on same graph below
```

```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_logistic <- predict(fit_tick_logistic_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_point(data=bins_for_plot, aes(x=HEIGHT, y=means), col="tomato1", size=3) + geom_errorbar(data=bins_for_plot, mapping =aes(x=HEIGHT, y=means, ymin=means-SDs, ymax=means+SDs), linewidth=1, color="tomato1", width=.4) + geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_logistic), linewidth=1)
```


#Analysis of Deviance
```{r}
anova(fit_tick_logistic_1, test="Chisq")
```

```{r}
intercept_only <- glm(TICK_PRES~1, data=grouseticks, family=binomial(link="logit"))
anova(intercept_only, fit_tick_logistic_1, test="Chisq")
```

# ROCs(Receiver operating characteristic curve = rock plot) and AUC (Area unver the curve)
Making a ROC plot
```{r}
library(pROC)
predicted <- predict(fit_tick_logistic_1, type="response")
roccurve <- roc(grouseticks$TICK_PRES ~ predicted)
ggroc(roccurve)+theme_classic()+geom_segment(aes(x=1, xend=0, y=0, yend=1), color="grey", linetype="dashed")
```

auc(roccurve)

############################################################################
#Poisson Regression (Count)

```{r}
fit_tick_poisson_1 <- glm(TICKS~HEIGHT, data=grouseticks, family=poisson(link="log"))
summary(fit_tick_poisson_1)
```

```{r}
new_data <- data.frame(HEIGHT = seq(400, 540, 0.001))
new_data$Predicted_TICKS_poisson <- predict(fit_tick_poisson_1, newdata=new_data, type="response")
ggplot(data=grouseticks, mapping=aes(x=HEIGHT, y=TICKS))+geom_point()+theme_classic()+geom_line(data=new_data, aes(x=HEIGHT, y=Predicted_TICKS_poisson), linewidth=1)
```

# Interpretation
the expected number of ticks changes by a multiplicative factor of 0.98 (= exp(−0.0230647)), or a 2.3% decrease (= (1−0.977)×100), with an increase in 1 unit of elevation.

# Checking assumptions and other diagnostics
```{r}
anova(fit_tick_poisson_1, test="Chisq")
```
#Overdispersion
```{r}
install.packages("AER")
library(AER)
deviance(fit_tick_poisson_1)/fit_tick_poisson_1$df.residual
```
```{r}
dispersiontest(fit_tick_poisson_1)
```

```{r}
library(MASS)
fit_tick_negbin_1 <- glm.nb(TICKS~HEIGHT, data=grouseticks)
summary(fit_tick_negbin_1)
```

# Zero-inflated Poisson
```{r}
install.packages("pscl")
library(pscl)
ZI_pois <- zeroinfl(TICKS~HEIGHT, data=grouseticks, dist="poisson")
summary(ZI_pois)
```
```{r}
AIC(fit_tick_poisson_1, ZI_pois)
```

# Zero-inflated Negative Binomial
```{r}
ZI_negbin <- zeroinfl(TICKS~HEIGHT, data=grouseticks, dist="negbin")
summary(ZI_negbin)
```
###########################################################################
# Fitting an offset variable
```{r}
beetles <- read.csv("C:/Users/chemk/Desktop/Classes/ENT6707_DataAnalysis/week11/examples/completely_fabricated_data/beetles.csv")
summary(beetles)
```

```{r}
set.seed(123)
beetles$woodlot_size <- runif(nrow(beetles), 1,2)
summary(beetles)
```

```{r}
fit_beetles_a <- glm(ELB/woodlot_size~temperature, data=beetles, family=poisson(link=log))
summary(fit_beetles_a)
```
#Use an offset vaiable, ensuring our response variable remains as an integer.
```{r}
fit3b <- glm(ELB~temperature + offset(woodlot_size),data=beetles,family=poisson(link=log))
summary(fit3b)
```

```{r}
fit3c <- glm(ELB~temperature + woodlot_size, data=beetles, family=poisson(link=log))
summary(fit3c)
```

#####################################################################################
#Generalized linear mixed-effects models
```{r}
grouseticks$TICK_PRES <- ifelse(grouseticks$TICKS > 0, 1, 0)
library(lme4)
glmer_binomial <- glmer(TICK_PRES ~ cHEIGHT + (1|BROOD), data=grouseticks, family=binomial(link="logit"))
summary(glmer_binomial)
```

#Plotting mixed effects logistic regression
```{r}
new_data_me <- data.frame(cHEIGHT=seq(-60, 71, 0.001))
new_data_me$Predicted_TICKS_logistic <- predict(glmer_binomial, newdata=new_data_me, type="response", re.form=NA)
ggplot(data=grouseticks, mapping=aes(x=cHEIGHT, y=TICK_PRES))+geom_point()+theme_classic()+geom_line(data=new_data_me, aes(x=cHEIGHT, y=Predicted_TICKS_logistic), linewidth=1)
```

# Poisson response variables
```{r}
glmer_poisson <- glmer(TICKS~cHEIGHT + (1|BROOD), data=grouseticks, family=poisson(link="log"))
summary(glmer_poisson)
```
# Plotting mixed effects Poisson regression
```{r}
new_data_pois_me <- data.frame(cHEIGHT = seq(-60, 71, 0.001))
new_data_pois_me$Predicted_TICKS_poisson <- predict(glmer_poisson, newdata=new_data_pois_me, type="response", re.form=NA)
ggplot(data=grouseticks, mapping=aes(x=cHEIGHT, y=TICKS))+geom_point()+theme_classic()+geom_line(data=new_data_pois_me, aes(x=cHEIGHT, y=Predicted_TICKS_poisson), linewidth=1)
```
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

# R Activity 10: Measures of species diversity 
```{r}
ants <- read.csv(file="C:/Users/chemk/Desktop/hf118-01-ants.csv", header=T, na.strings=c("",".","NA"))
str(ants)
```

```{r}
library(reshape2)
ant.matrix <- dcast(ants, year+block+plot+treatment+trap.type~code, sum, value.var="abundance", na.rm=TRUE) #na.rm = 결측치를 무시하고 계산을 진행
str(ant.matrix)
View(ant.matrix)
```

```{r}
#change variables to factors
ant.matrix$year <- as.factor(ant.matrix$year)
ant.matrix$block <- as.factor(ant.matrix$block)
ant.matrix$plot <- as.factor(ant.matrix$plot)
ant.matrix$treatment <- as.factor(ant.matrix$treatment)
ant.matrix$trap.type <- as.factor(ant.matrix$trap.type)
summary(ant.matrix)
#shorten treatment names
levels(ant.matrix$treatment)
```

```{r}
levels(ant.matrix$treatment) [levels(ant.matrix$treatment)=="HardwoodCOntrol"] <- "Hardwood"
levels(ant.matrix$treatment) [levels(ant.matrix$treatment)=="HemlockControl"] <- "Hemlock"
levels(ant.matrix$year)
```

```{r}
library(dplyr)
library(stats)
yr1 <- ant.matrix %>% dplyr::filter(year== "2015") %>% droplevels()
yr2 <- ant.matrix %>% dplyr::filter(year== "2018") %>% droplevels()
```

```{r}
ants2 <- rbind(yr1, yr2)
str(ants)
View(ants2)
```
```{r}
ants3 <- ants2[, colSums(ants2 !=0) > 0]
str(ants)
View(ants3)
```

```{r}
ants3$totabund <- rowSums(ants3[6:38]) # rowSums 함수는 지정된 열들의 각 행에 대해 합계를 계산합니다.
View(ants3)
colSums(ants3[6:38])
colSums(ants3[39])




# Abundance--------------------------------------------------------------------------------------------------------------------------------
```{r}
ant.dom <- colSums(ants2[,6:54]) # sum abundances across sites (이 수식은 ants2 데이터프레임에서 6번째부터 54번째 열까지의 값을 합산하여, 각 열의 합계를 구하는 작업입니다.) 
ant.dom <- as.data.frame(ant.dom) # change to data frame (as.data.frame(ant.dom)는 ant.dom을 데이터프레임으로 변환하는 수식입니다.)
View(ant.dom)
names(ant.dom)[1] <- "count" # rename the abundance column, (names(ant.dom)[1] <- "count"는 ant.dom 데이터프레임의 첫 번째 열 이름을 "count"로 변경하는 수식입니다.)
View(ant.dom)
ant.dom$species <- rownames(ant.dom) # make a column of species (ant.dom 데이터프레임의 species라는 새로운 열을 추가하고, 그 열의 값으로 ant.dom의 각 행의 이름을 할당하는 수식입니다.)
View(ant.dom)
str(ant.dom)
ant.dom$species <- as.factor(ant.dom$species) # change species to a factor
```

```{r}
library(ggplot2)
library(forcats)
ant.dom %>% mutate(species =fct_reorder(species, desc(count))) %>% ggplot(aes(x=species, y=count))+
  geom_bar(stat="identity", fill="seagreen", alpha=.6, width=.4) +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))+
  xlab("Ant Species")+
  ylab("Abundance")
```

```{r}
barplot(sort(colSums(ants2[,6:54]),decreasing=T), col="seagreen",
        xlab="", ylab="Abundance", las = 2, ylim = c(0, 800)) # another way to do the same thing
```

# let's graph species abundance again
```{r}
barplot(sort(colSums(ants3[,6:38]),decreasing=T), col="seagreen",
        xlab="", ylab="Abundance", las = 2, ylim = c(0, 800))
```


# Richness --------------------------------------------------------------------------------------------------------------------------------
# Count the number of species

```{r}
ants3 <- ants2[, colSums(ants2 !=0) > 0]
str(ants)
View(ants3)
```

```{r}
ants3$totabund <- rowSums(ants3[6:20]) # rowSums 함수는 지정된 열들의 각 행에 대해 합계를 계산합니다.
View(ants3)
colSums(ants3[6:38])
colSums(ants3[39])
```

```{r}
# let's graph species abundance again
barplot(sort(colSums(ants3[,6:38]),decreasing=T), col="seagreen",
        xlab="", ylab="Abundance", las = 2, ylim = c(0, 800))
```

```{r}
library(vegan)
ants3$sp.rich <- specnumber(ants3[,6:39])
par(mar=c(6,4,2,2))
str(ants3$sp.rich)
str(ants3$treatment)
any(is.na(ants3$sp.rich))
any(is.na(ants3$treatment))
boxplot(sp.rich ~ treatment, data = ants3, xlab = "", ylab = "Ant species richness", cex.axis = 1, las = 2) + stripchart(sp.rich ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

# Species accumulation curves
### Estimate species richness with accumulation curves
individual-based rarefaction by treatment, jackknife estimates by treatment
we are separating out each treatment so we can get a species accumulation curve for each, and then we will graph it

```{r}
levels(ants3$treatment) #Treatment 변수의 범주형 레벨(treatment가 가질 수 있는 값들)을 확인. 즉 treatment 변수에 어떤 종류의 처리(Girdled, HardwoodControl, 등)가 포함되어 있는지 확인
girdled <- ants3[which(ants3$treatment == "Girdled"),] #treatment 값이 "HardwoodControl"인 행만 필터링하여 hardwood 객체에 저장
hardwood <- ants3[which(ants3$treatment == "HardwoodControl"),]
hemlock <- ants3[which(ants3$treatment == "HemlockControl"),]
logged <- ants3[which(ants3$treatment == "Logged"),]
```

still using the R package vegan
the rarefaction method standardizes the sample sizes so that we are comparing species richness at equivalent abundances

```{r}
sp.girdled <- specaccum(girdled[6:38], method = "rarefaction", permutations = 100, gamma = "jack2")
sp.hardwood <- specaccum(hardwood[6:38], method = "rarefaction", permutations = 100, gamma = "jack2")
any(is.na(hemlock[6:38]))
all(hemlock[6:38] == 0)
colSums(hemlock[6:38] == 0)
sp.hemlock <- specaccum(hemlock[6:38], method = "rarefaction", permutations = 100, gamma = "jack2") #This doesn't work
sp.logged<-specaccum(logged[6:38], method="rarefaction", permutations=100,gamma="jack2")
```

```{r}
plot(sp.girdled,pch=19,col="#481567FF",xvar= c("individuals"),
 lty=4,lwd=3,
 ylab="SpeciesRichness",xlab="NumberofIndividuals",
 xlim=c(0,600),ylim=c(0, 35))+
plot(sp.hardwood,add=TRUE,pch=15,xvar= c("individuals"),
 lty=1,lwd=3,col="#FDE725FF")+
plot(sp.logged,add=TRUE,pch=9,xvar= c("individuals"),
 lty=3,lwd=3,col="#2D708EFF")+
legend("bottomright",legend=c("Hemlock","Girdled","Logged","Hardwood"),
 lty=c(1,2,3,4),cex=1,bty="n",lwd=3,
 col=c("#73D055FF","#481567FF","#2D708EFF","#FDE725FF"))
```

```{r}
install.packages("fossil")
library(fossil)
```

```{r}
jack1(hardwood[6:38], taxa.row = FALSE, abund = TRUE)
jack2(hardwood[6:38], taxa.row = FALSE, abund = TRUE)
specnumber(ants3[,6:38], groups = ants3$treatment)
```

# Diversity ------------------------------------------------------------------------------------------------------
```{r}
install.packages("hillR")
library(hillR)
library(vegan)
```

# Shannon diversity index
```{r}
ants3$sh.div <- diversity(ants3[,6:38], index = "shannon")
par(mar=c(6,4,2,2))
boxplot(sh.div ~ treatment, data = ants3, xlab = "", ylab = "Species diversity (H)", cex.axis = 1, las = 2)+
  stripchart(sh.div ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

# Simpson diversity index
```{r}
ants3$sp.div <- diversity(ants3[,6:38], index = "simpson")
par(mar=c(6,4,2,2))
boxplot(sp.div ~ treatment, data = ants3, xlab = "", ylab = "Species diversity (D)", cex.axis = 1, las = 2)+
  stripchart(sp.div ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

# Effective number of species = Hill numbers

```{r}
hill_taxa(ants3[,6:20], q = 0, MARGIN = 1)
hill_taxa(ants3[,6:20], q = 1, MARGIN = 1) 
hill_taxa(ants3[,6:20], q = 2, MARGIN = 1)
```

Species richness (q=0) 
```{r}
ants3$hill.rich <- hill_taxa(ants3[,6:38], q = 0, MARGIN = 1)
par(mar=c(6,4,2,2))
boxplot(hill.rich ~ treatment, data = ants3, xlab = "", ylab = "Species Richness",cex.axis = 1, las = 2)+
  stripchart(hill.rich ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

Shannon ENS (q=1)
```{r}
ants3$hill.shan <- hill_taxa(ants3[,6:38], q = 1, MARGIN = 1)
par(mar=c(6,4,2,2))
boxplot(hill.shan ~ treatment, data = ants3, xlab = "", ylab = "ENS Shannon", cex.axis = 1, las = 2)+
  stripchart(hill.shan ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

Simpson ENS (q=2)
```{r}
ants3$hill.simp <- hill_taxa(ants3[,6:38], q = 2, MARGIN = 1)
par(mar=c(6,4,2,2))
boxplot(hill.simp ~ treatment, data = ants3, xlab = "", ylab = "ENS Simpson", cex.axis = 1, las = 2)+
  stripchart(hill.simp ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

 
# Evenness: measures the relative abundance of each type ----------------------------------------------------------------------------------
```{r}
install.packages("chemodiv")
library(chemodiv)
```


```{r}
calcDiv(ants3[,6:38], type = "PielouEven")
calcDiv(ants3[,6:38], type = "HillEven", q = 1)
calcDiv(ants3[,6:38], type = "HillEven", q = 2)
```

# Pielou's J
```{r}
ants3$sp.evenJ <- calcDiv(ants3[,6:38], type = "PielouEven")
par(mar=c(6,4,2,2))
boxplot(sp.evenJ$PielouEven ~ treatment, data = ants3, xlab = "", ylab = "Species evenness (J)", cex.axis = 1, las = 2)+
  stripchart(sp.evenJ$PielouEven ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

# Species evenness derived from Hill numbers
Species evenness can be derived from ENS Shannon and ENS Simpson indices. These metrics are calculated by dividing the ENS indices by the observed number of species.

ENS Shannon
```{r}
ants3$sp.evenSh <- calcDiv(ants3[,6:38], type = "HillEven", q = 1)
par(mar=c(6,4,2,2))
boxplot(sp.evenSh$HillEven ~ treatment, data = ants3, xlab = "", ylab = "Shannon Evenness", cex.axis = 1, las = 2)+
  stripchart(sp.evenSh$HillEven ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

ENS Simpson
```{r}
ants3$sp.evenSp <- calcDiv(ants3[,6:38], type = "HillEven", q = 2)
par(mar=c(6,4,2,2))
boxplot(sp.evenSp$HillEven ~ treatment, data = ants3, xlab = "", ylab = "Simpson Evenness", cex.axis = 1, las = 2)+
  stripchart(sp.evenSp$HillEven ~ treatment, data = ants3, pch = 19, add = TRUE, vertical = TRUE, method = "jitter", jitter = 0.2)
```

_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________
_______________________________________________________________________________________________________________

# R Activity Practice_11

## Road ants data---------------------------------------------------------------------------------------------
```{r}
ants <- read.csv(file="https://pasta.lternet.edu/package/data/eml/knb-lter-hfr/118/35/90ca76917fe458ee78390c30de46afe5", header=T, na.strings=c("",".","NA"))
```

```{r}
View(ants)
head(ants)
tail(ants)
summary(ants)
str(ants)
```
## reshape from long format to wide format
```{r}
library(reshape2)
ant.matrix <- dcast(ants, year+block+plot+treatment+trap.type~code, sum, value.var="abundance", na.rm=TRUE)
View(ant.matrix)
```

## change variables to factors
```{r}
ant.matrix$year<-as.factor(ant.matrix$year)
ant.matrix$block<-as.factor(ant.matrix$block)
ant.matrix$plot<-as.factor(ant.matrix$plot)
ant.matrix$treatment<-as.factor(ant.matrix$treatment)
ant.matrix$trap.type<-as.factor(ant.matrix$trap.type
```

## check the levels of factor data
```{r}
levels(ant.matrix$year)
```
## filter and remove(droplevels) levels that is not filtered
```{r}
library(dplyr)
yr1 <- ant.matrix %>% filter(year=="2015") %>% droplevels()
yr2 <- ant.matrix %>% filter(year=="2018") %>% droplevels()
```

## Re-bind/combine data frames row by row
```{r}
ants2 <- rbind(yr1, yr2)
View(ants2)
```

## Columns that contain only zeros are removed, and only the columns with at least one non-zero value remain
```{r}
ants3 <- ants2[, colSums(ants2 !=0)>0]
View(ants3)
```

## Load understory data-----------------------------------------------------------------------------------------
```{r}
herb<-read.csv(file="https://pasta.lternet.edu/package/data/eml/knb-lter-hfr/106/33/417bcd2b9b90c63460d893c43d53ec8c", header=T,na.strings=c("",".","NA"))
```

```{r}
View(herb)
head(herb)
tail(herb)
summary(herb)
str(herb)
```
## species codes are provided in the csv file hg106-01-species-codes
```{r}
herb$species <- as.factor(herb$species)
```

## reshape from long format to wide format
```{r}
herb.matrix <- dcast(herb, year+block+trt+plot ~ species, mean, value.var="cover", fill=0)
```

## filter and remove(droplevels) levels that is not filtered
```{r}
yr1.herb <- herb.matrix %>% filter(year == "2015") %>% droplevels()
yr2.herb <- herb.matrix %>% filter(year == "2018") %>% droplevels()
```

```{r}
herb2 <- rbind(yr1.herb, yr2.herb)
```

## remove columns of species that were not observed or observed at low frequencies
```{r}
herb3 <- herb2[, colSums(herb2 !=0)> 2]
```


## Ordination methods : indirect gradient analysis / direct gradient analysis--------------------------------------
```{r}
library(vegan)
```

## Indirect gradient analysis (unconstrained ordination) utilizes only the species by sample matrix---------------
## NMDS(Nonmetric Multidimensional Scaling), PCA(Principal Component Analysis)

## NMDS: Nonmetric multidimensional scaling----------------------------------------------------------------------
assess differences in species composition among samples, sites, trts

### change ant data to presence/absence
```{r}
ants4 <- ants3 [,6:38] # save as a new object
View(ants4)
ants4[ants4>0] <- 1 # if a value is greater than zero, replace it with 1
ants4$treatment <- ants3$treatment # add the treatments back into the data set
View(ants4)
```

## Dissimilarity metrix
```{r}
dis.matrix.pa <- vegdist(ants4[, 1:33], method = "jaccard")
```

## NMDS model
```{r}
nmds.ants.pa <- metaMDS(dis.matrix.pa, trymax=500, autotransform = TRUE, k=2)
```

## plot the NMDS model (stressplot)
```{r}
stressplot(nmds.ants.pa)
```
```{r}
str(nmds.ants.pa)
site_scores <- scores(nmds.ants.pa, display="sites")
head(site_scores)
```


```{r}
library(vegan)
ordiplot(nmds.ants.pa,disp="sites",type="n", xlim= c(-1.5,1.5),ylim=c(-1.5,1.5))
points(x,"sites",select= which(ants3$treatment=="HemlockControl"),pch=17,cex=1, col="#73D055FF")
points(nmds.ants.pa,disp="sites",select= which(ants3$treatment=="HemlockControl"),pch=17,cex=1, col="#73D055FF")
points(nmds.ants.pa,disp="sites",select= which(ants3$treatment=="Girdled"),pch = 18,cex=1,col="#481567FF")
points(nmds.ants.pa,disp="sites",select= which(ants3$treatment=="Logged"),pch=15,cex=1,col="#2D708EFF")
points(nmds.ants.pa,disp="sites",select= which(ants3$treatment=="HardwoodControl"),pch=16,cex=1, col="#FDE725FF")
ordiellipse(nmds.ants.pa,ants3$treatment,draw="lines",col=c("#73D055FF","#481567FF","#2D708EFF","#FDE725FF"), lwd=3,kind="sd",conf=0.90,label=FALSE)
legend("topleft",legend= c("Hemlock","Girdled","Logged","Hardwood"), pch=c(17,18,15,16),cex=1,bty="n",col=c("#73D055FF","#481567FF","#2D708EFF","#FDE725FF")
```

## NMDS model - PERMANOVA: permutational multivariate analysis of variance
```{r}
adonis2(dis.matrix.pa~ants4$treatment, permutations=999)
```
```{r}
install.packages("devtools")
install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)
pairwise.adonis(dis.matrix.pa, ants4$treatment)
```


## NMDS model - BETADISPER: Homogeneity of multivariate group dispersion
```{r}
ants.beta.pa <- betadisper(dis.matrix.pa, ants4$treatment, type=c("median"))
```
```{r}
anova(ants.beta.pa)
```

```{r}
plot(ants.beta.pa)
```


## PCA (Principal component analysis)---------------------------------------------------------------------------
```{r}
herb.pca <- rda(herb3[,5:23], scale=FALSE)
# if RDA function is used without explanatory variables, then it calculates a PCA
summary(herb.pca)
species_scores <- scores(herb.pca, display = "species")
species_scores
site_scores <- scores(herb.pca, display = "sites")
site_scores
```
```{r}
herb.pca$sites
str(herb.pca)
herb.pca$CA$u
herb.pca$sites <- herb.pca$CA$u
```


```{r}
library(vegan)
ordiplot(herb.pca, display = 'sites', type = 'n')
points(herb.pca, dis = "sites", select = which(herb3$trt=="hemlock"), pch = 17, cex = 1, col = "#73D055FF")
points(herb.pca, dis = "sites", select = which(herb3$trt=="girdled"), pch = 18, cex = 1, col = "#481567FF")
points(herb.pca, dis = "sites", select = which(herb3$trt=="logged"), pch = 15, cex = 1, col = "#2D708EFF")
points(herb.pca, dis = "sites", select = which(herb3$trt=="hardwood"), pch = 16, cex = 1, col = "#FDE725FF")
orditorp(herb.pca, display = 'sp')
legend("topleft", legend = c("Hemlock", "Girdled", "Logged", "Hardwood"), pch = c(17, 18, 15, 16), cex = 1, bty = "n", col = c("#73D055FF", "#481567FF", "#2D708EFF", "#FDE725FF")
```

## Direct gradient analysis------------------------------------------------------------------------------
## Constrained ordination; untilizes environmental data in addition to a species by site matrix
## RDA (Redundancy Analysis) / CCA (Canonical Correspondence Analysis)

## RDA (Redundancy Analysis)-----------------------------------------------------------------------------

```{r}
ants.rda <- rda(ants3[,6:38]~., herb3[,5:23])
summary(ants.rda)
```
```{r}
mod0.rda <- rda(ants3[,6:38]~1, herb3[,5:23])
ants.rda.red <- ordistep(mod0.rda, scope=formula(ants.rda), direction="both", permutations=how(nperm=199))
```


```{r}
summary(ants.rda.red) # which environmental variables are important
```

```{r}
anova(ants.rda.red, by='axis') #which axes are important
```

```{r}
ordiplot(ants.rda.red, display = c('si', 'cn'), type = 'n')
 points(ants.rda.red, dis = "sites", select = which(herb3$trt=="hemlock"), pch = 17, cex = 1, col = "#73D055FF")
 points(ants.rda.red, dis = "sites", select = which(herb3$trt=="girdled"), pch = 18, cex = 1, col = "#481567FF")
 points(ants.rda.red, dis = "sites", select = which(herb3$trt=="logged"), pch = 15, cex = 1, col = "#2D708EFF")
 points(ants.rda.red, dis = "sites", select = which(herb3$trt=="hardwood"), pch = 16, cex = 1, col = "#FDE725FF")
 text(ants.rda.red, display = 'cn', col = 'navy', cex = 1)
 orditorp(ants.rda.red, display = 'sp')
 legend("bottomright", legend = c("Hemlock", "Girdled", "Logged", "Hardwood"), pch = c(17, 18, 15, 16), cex = 1, bty = "n", col = c("#73D055FF", "#481567FF", "#2D708EFF", "#F
```

## CCA (Canonical Correspondence Analysis)---------------------------------------------------------------------
```{r}
ants.cca <- cca(ants3[,6:38]~., herb3[,5:23])
mod0.cca <- cca(ants3[,6:38] ~ 1, herb3[,5:23])
ants.cca.red <- ordistep(mod0.cca, scope = formula(ants.cca), direction = "both",
permutations = how(nperm = 199))
```

```{r}
summary(ants.cca.red) #which environmental variables are important
```

```{r}
anova(ants.cca.red, by='axis') # which axes are important
```

```{r}
 ordiplot(ants.cca.red, display = c('si', 'cn'), type = 'n')
 points(ants.cca.red, dis = "sites", select = which(herb3$trt=="hemlock"), pch = 17, cex = 1, col = "#73D055FF")
 points(ants.cca.red, dis = "sites", select = which(herb3$trt=="girdled"), pch = 18, cex = 1, col = "#481567FF")
 points(ants.cca.red, dis = "sites", select = which(herb3$trt=="logged"), pch = 15, cex = 1, col = "#2D708EFF")
 points(ants.cca.red, dis = "sites", select = which(herb3$trt=="hardwood"), pch = 16, cex = 1, col = "#FDE725FF")
 text(ants.cca.red, display = 'cn', col = 'navy', cex = 1)
 orditorp (ants.cca.red, display = 'sp')
 legend("topright", legend = c("Hemlock", "Girdled", "Logged", "Hardwood"),
 pch = c(17, 18, 15, 16), cex = 1, bty = "n", col = c("#73D055FF", "#481567FF", "#2D708EFF", "#F
```

## How to select which method (CCA or RDA) to use

## DCA (Detrended Correspondence Analysis)

```{r}
DCA <- decorana(ants3[,6:38])
DCA
```

